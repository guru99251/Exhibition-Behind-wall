<!DOCTYPE html>
<html lang="ko" class="page">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Behind Wall · Live Comments</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <!-- (Optional) GSAP — kept in case you add transitions later -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <style>
    :root {
      --bg: #0e0f0f;
      --bg-soft: #121415;
      --text: #d1d1d1;
      --muted: rgba(226,232,240,.72);
      --border: rgba(255,255,255,.12);
      --border-strong: rgba(255,255,255,.26);
      --glow: rgba(125,211,252,.35);
      --accent-a: #7dd3fc; /* Zone A */
      --accent-b: #a3e635; /* Zone B */
      --accent-c: #fb7185; /* Zone C */
      --accent-all: #facc15; /* All  */
      --sidebar-w: clamp(220px, 18vw, 320px);
      --gutter: clamp(16px, 2.4vw, 28px);
      --radius-lg: 18px;
      --radius-md: 14px;
      --shadow: 0 18px 42px rgba(0,0,0,.36);
      --card-shadow: 0 12px 28px rgba(0,0,0,.26);
    }

    /* ===== Base ===== */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html.page { overflow: hidden; }
    body.page.page-comment {
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,.04), transparent 60%),
        var(--bg);
      font-family: 'DM Sans', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
    }

    #mosaic { position: fixed; inset: 0; opacity: .55; pointer-events: none; }
    .page-backdrop { position: fixed; inset: 0; pointer-events: none; background: radial-gradient(60% 60% at 20% 20%, rgba(148,163,184,.22) 0%, transparent 100%); mix-blend-mode: screen; opacity:.65; }

    /* ===== Sidebar (fixed) ===== */
    .wall-sidebar { position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-w); padding: clamp(18px, 2.2vw, 24px); background: rgba(14,15,16,.78); backdrop-filter: blur(10px); border-right: 1px solid var(--border); box-shadow: var(--shadow); z-index: 3; }
    .wall-sidebar__nav { height: 100%; display: grid; align-content: start; gap: 12px; }
    .wall-sidebar__list { list-style: none; margin: 0; padding: 0; display: grid; gap: 8px; }
    .wall-sidebar__list a { display: block; width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 12px; color: var(--text); text-decoration: none; background: rgba(20,22,24,.72); transition: border-color .25s ease, box-shadow .25s ease, transform .2s ease; }
    .wall-sidebar__list a:hover { border-color: var(--border-strong); box-shadow: 0 10px 26px rgba(56,189,248,.18); transform: translateY(-1px); }
    .wall-sidebar__list a[aria-current="page"] { border-color: rgba(226,232,240,.8); box-shadow: 0 12px 28px rgba(226,232,240,.18); }
    .home-nav { font-weight: 700; letter-spacing: .08em; text-transform: uppercase; }

    /* ===== Main Shell ===== */
    .shell { position: relative; height: 100vh; padding: var(--gutter); padding-left: calc(var(--sidebar-w) + var(--gutter)); display: grid; grid-template-rows: auto 1fr; gap: var(--gutter); z-index: 2; }

    /* Header / Connection badge */
    .bar { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 16px; padding: 14px 16px; border: 1px solid var(--border); background: rgba(12,14,16,.78); border-radius: var(--radius-lg); box-shadow: var(--shadow); }
    .bar h1 { margin: 0; font-size: clamp(18px, 2.2vw, 24px); letter-spacing: .12em; text-transform: uppercase; }
    .status { display: inline-grid; grid-auto-flow: column; gap: 10px; align-items: center; padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: rgba(18,22,28,.84); box-shadow: var(--card-shadow); font-size: 14px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #fca5a5; box-shadow: 0 0 0 0 rgba(252,165,165,.35); }
    .status[data-state="online"] .dot { background: #86efac; animation: ping 1.6s infinite; }
    @keyframes ping { 0%{ box-shadow:0 0 0 0 rgba(134,239,172,.45) } 70%{ box-shadow:0 0 0 10px rgba(134,239,172,0) } 100%{ box-shadow:0 0 0 0 rgba(134,239,172,0) } }

    /* ===== 4 Columns ===== */
    .columns { height: calc(100vh - (var(--gutter) * 2) - 62px); display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: var(--gutter); }
    .col { position: relative; border: 1px solid var(--border); background: rgba(10,11,12,.82); border-radius: var(--radius-lg); box-shadow: var(--shadow); display: grid; grid-template-rows: auto 1fr; min-width: 0; }
    .col__head { display: grid; grid-auto-flow: column; align-items: center; justify-content: space-between; gap: 8px; padding: 12px 14px; border-bottom: 1px solid var(--border); background: rgba(18,22,28,.78); border-top-left-radius: var(--radius-lg); border-top-right-radius: var(--radius-lg); }
    .col__head h2 { margin: 0; font-size: clamp(14px, 1.6vw, 16px); letter-spacing: .12em; text-transform: uppercase; opacity:.92; }
    .col__head .count { font-variant-numeric: tabular-nums; opacity:.8; }
    .col[data-zone="A"] .col__head { border-bottom-color: color-mix(in oklab, var(--accent-a) 45%, white 0%); }
    .col[data-zone="B"] .col__head { border-bottom-color: color-mix(in oklab, var(--accent-b) 45%, white 0%); }
    .col[data-zone="C"] .col__head { border-bottom-color: color-mix(in oklab, var(--accent-c) 45%, white 0%); }
    .col[data-zone="ALL"] .col__head { border-bottom-color: color-mix(in oklab, var(--accent-all) 45%, white 0%); }

    .list { overflow: auto; padding: 12px; display: grid; align-content: start; gap: 10px; }

    /* ===== Comment Card ===== */
    .card { position: relative; display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-md); background: linear-gradient(180deg, rgba(22,26,32,.88), rgba(16,18,22,.92)); box-shadow: var(--card-shadow); animation: pop .25s ease; }
    @keyframes pop { from { transform: translateY(4px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }

    .meta { font-size: 12px; color: var(--muted); display: grid; grid-auto-flow: column; gap: 6px; align-items: center; justify-content: start; }
    .name { font-weight: 700; color: #e5e7eb; }
    .dept { opacity: .85; }
    .time { opacity: .66; }

    .text { font-size: clamp(13px, 1.45vw, 15px); line-height: 1.55; color: #f3f4f6; word-break: break-word; }

    .poster { width: clamp(54px, 8vw, 80px); aspect-ratio: 3/4; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); background: #111; align-self: start; }
    .poster img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .actions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .chip { display: inline-grid; grid-auto-flow: column; gap: 6px; align-items: center; padding: 6px 8px; border-radius: 999px; border: 1px solid var(--border); background: rgba(28,34,40,.72); font-size: 12px; }
    .chip .emoji { font-size: 14px; }
    .chip .n { font-variant-numeric: tabular-nums; opacity:.9; }

    /* Compact height on very short screens */
    @media (max-height: 720px) {
      .columns { height: calc(100vh - (var(--gutter) * 2) - 54px); }
      .bar { padding: 10px 12px; }
      .col__head { padding: 10px 12px; }
      .card { padding: 8px 10px; }
    }

    /* Keep all four columns visible on narrow widths by reducing base font size */
    @media (max-width: 1100px) {
      html { font-size: 14px; }
    }
    @media (max-width: 960px) {
      :root { --sidebar-w: 200px; }
      html { font-size: 13px; }
    }
    @media (max-width: 820px) {
      :root { --sidebar-w: 180px; }
      html { font-size: 12px; }
    }
    @media (max-width: 760px) {
      :root { --sidebar-w: 160px; }
      html { font-size: 11px; }
    }
    @media (max-width: 700px) {
      :root { --sidebar-w: 140px; }
      html { font-size: 10px; }
    }
  </style>
</head>

<body class="page page-comment">
  <!-- fixed sidebar -->
  <aside class="wall-sidebar" aria-label="Site navigation">
    <nav class="wall-sidebar__nav">
      <ul class="wall-sidebar__list">
        <li><a href="index.html" class="home-nav">Lobby</a></li>
        <li><a href="01-wall.html">Wall</a></li>
        <li><a href="02-comment.html" aria-current="page">Comments</a></li>
        <li><a href="03-contributors.html">Contributors</a></li>
        <li><a href="04-artworks.html">Artworks</a></li>
      </ul>
    </nav>
  </aside>

  <div id="mosaic" aria-hidden="true"></div>
  <div class="page-backdrop" aria-hidden="true"></div>

  <section class="shell" id="commentShell" aria-label="Live comments">
    <header class="bar">
      <h1>Live Comments · Diposium</h1>
      <div class="status" id="connBadge" data-state="offline" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <span class="label">Offline</span>
      </div>
    </header>

    <div class="columns" id="columns">
      <section class="col" data-zone="A" aria-label="Zone A">
        <div class="col__head"><h2>Zone A</h2><span class="count" data-count>0</span></div>
        <div class="list" data-list></div>
      </section>
      <section class="col" data-zone="B" aria-label="Zone B">
        <div class="col__head"><h2>Zone B</h2><span class="count" data-count>0</span></div>
        <div class="list" data-list></div>
      </section>
      <section class="col" data-zone="C" aria-label="Zone C">
        <div class="col__head"><h2>Zone C</h2><span class="count" data-count>0</span></div>
        <div class="list" data-list></div>
      </section>
      <section class="col" data-zone="ALL" aria-label="All">
        <div class="col__head"><h2>All</h2><span class="count" data-count>0</span></div>
        <div class="list" data-list></div>
      </section>
    </div>
  </section>

  <script>
    // ===== Config =====
    const WS_URL = new URLSearchParams(location.search).get('ws') || 'wss://echo.websocket.events';
    const MAX_PER_COL = 200; // prevent unbounded growth

    // ===== Store =====
    const store = {
      A: [], B: [], C: [], ALL: [],
      index: new Map(), // id -> item
    };

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', () => {
      initCommentPage(document.getElementById('commentShell'));
      connectCommentsWS(WS_URL);
      // Optional demo feed if you add ?demo=1
      if (new URLSearchParams(location.search).get('demo') === '1') startDemo();
    });

    // ===== Functions per PROJECT_STRUCTURE.md =====
    function initCommentPage(container){
      fitToWidth();
      window.addEventListener('resize', fitToWidth, { passive: true });
    }

    function connectCommentsWS(url){
      let ws, heart, retry = 0, closedByApp = false;
      const BADGE = document.getElementById('connBadge');

      const open = () => {
        ws = new WebSocket(url);
        ws.addEventListener('open', () => {
          retry = 0;
          updateConnectionBadge('online');
          // announce presence
          safeSend({ type: 'hello', role: 'display', ua: navigator.userAgent });
          heart = setInterval(() => safeSend({ type:'ping', t: Date.now() }), 25000);
        });
        ws.addEventListener('message', (ev) => {
          let data;
          try { data = JSON.parse(ev.data); } catch { return; }
          if (!data) return;
          const zone = mapIncomingToZone(data);
          if (!zone) return;
          upsertMessage(store, zone, normalizeItem(data));
          renderColumn(zone, store[zone]);
          // All column mirrors every message (global timeline)
          if (zone !== 'ALL') {
            upsertMessage(store, 'ALL', normalizeItem(data));
            renderColumn('ALL', store.ALL);
          }
        });
        ws.addEventListener('close', () => {
          clearInterval(heart); heart = null;
          updateConnectionBadge('offline');
          if (!closedByApp) {
            const timeout = Math.min(1000 * Math.pow(2, retry++), 15000);
            setTimeout(open, timeout);
          }
        });
        ws.addEventListener('error', () => { try{ ws.close(); }catch{} });
      };
      const safeSend = (obj) => { try { ws && ws.readyState === 1 && ws.send(JSON.stringify(obj)); } catch { /*noop*/ } };
      const close = () => { closedByApp = true; try{ ws && ws.close(); }catch{} };
      open();
      // Expose for debugging
      window._socket = { close };
    }

    function mapIncomingToZone(event){
      const z = (event.zone || event.targetZone || '').toString().toUpperCase();
      if (['A','B','C','ALL'].includes(z)) return z;
      return 'ALL';
    }

    function upsertMessage(store, zone, item){
      if (!item || !item.id) return;
      // De-dupe globally
      if (store.index.has(item.id)) return;
      store.index.set(item.id, true);
      const arr = store[zone];
      arr.unshift(item); // newest-first
      if (arr.length > MAX_PER_COL) arr.length = MAX_PER_COL;
    }

    function renderColumn(zone, items){
      const col = document.querySelector(`.col[data-zone="${zone}"]`);
      if (!col) return;
      const list = col.querySelector('[data-list]');
      const count = col.querySelector('[data-count]');
      count.textContent = items.length;
      // Efficient paint with a fragment
      const frag = document.createDocumentFragment();
      items.forEach(item => frag.appendChild(renderCommentCard(item)));
      list.replaceChildren(frag);
    }

    function renderCommentCard(item){
      const card = document.createElement('article');
      card.className = 'card';
      // Left stack
      const left = document.createElement('div');
      const meta = document.createElement('div'); meta.className = 'meta';
      const name = document.createElement('span'); name.className = 'name';
      name.textContent = item.author?.anonymous ? 'Anonymous' : (item.author?.name || 'Guest');
      const dept = document.createElement('span'); dept.className = 'dept';
      dept.textContent = item.author?.anonymous ? '' : [item.author?.department, item.author?.studentId].filter(Boolean).join(' / ');
      const time = document.createElement('time'); time.className = 'time'; time.dateTime = new Date(item.time).toISOString(); time.textContent = timeAgo(item.time);
      meta.append(name, dept, time);

      const text = document.createElement('div'); text.className = 'text'; text.textContent = item.text || (item.type === 'emoji' ? '' : '');

      const actions = document.createElement('div'); actions.className = 'actions';
      // Reactions
      (item.reactions || []).forEach(r => {
        const chip = document.createElement('span'); chip.className = 'chip';
        const em = document.createElement('span'); em.className = 'emoji'; em.textContent = r.emoji;
        const n = document.createElement('span'); n.className = 'n'; n.textContent = r.count;
        chip.append(em, n); actions.appendChild(chip);
      });
      // Like counter
      if (typeof item.likes === 'number') {
        const like = document.createElement('span'); like.className = 'chip';
        like.innerHTML = '<span class="emoji">👍</span><span class="n">' + item.likes + '</span>';
        actions.appendChild(like);
      }
      // Emoji-only message
      if (item.type === 'emoji' && item.text === '' && item.reactions?.length === 1 && !item.artwork) {
        text.textContent = item.reactions[0].emoji;
        text.style.fontSize = 'clamp(26px, 4vw, 42px)';
      }

      left.append(meta);
      if (text.textContent) left.append(text);
      if (actions.childElementCount) left.append(actions);

      // Poster (optional)
      let posterWrap = null;
      if (item.artwork && item.artwork.poster) {
        posterWrap = document.createElement('figure'); posterWrap.className = 'poster';
        const img = document.createElement('img'); img.alt = item.artwork.title ? (item.artwork.title + ' poster') : 'Artwork poster'; img.loading = 'lazy'; img.src = item.artwork.poster;
        posterWrap.appendChild(img);
      }

      if (posterWrap) card.append(left, posterWrap); else { card.append(left); }
      return card;
    }

    function updateConnectionBadge(state){
      const el = document.getElementById('connBadge');
      el.dataset.state = state === 'online' ? 'online' : 'offline';
      el.querySelector('.label').textContent = (state === 'online') ? 'Online' : 'Offline';
    }

    function fitToWidth(){
      // Ensure the 4 columns + gutters fit. We reduce base font size progressively via CSS @media rules.
      // Here we could apply additional tweaks if needed in the future.
    }

    // ===== Helpers =====
    function normalizeItem(d){
      // Map various client payloads into a stable structure
      return {
        id: d.id || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
        type: d.type || 'comment',
        zone: (d.zone || d.targetZone || 'ALL').toUpperCase(),
        text: typeof d.text === 'string' ? d.text : '',
        author: d.author || { anonymous: true },
        reactions: Array.isArray(d.reactions) ? d.reactions : [],
        likes: typeof d.likes === 'number' ? d.likes : undefined,
        artwork: d.artwork || null,
        time: d.time || Date.now(),
      };
    }

    function timeAgo(t){
      const s = Math.floor((Date.now() - Number(t)) / 1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s / 60); if (m < 60) return `${m}m ago`;
      const h = Math.floor(m / 60); if (h < 24) return `${h}h ago`;
      const d = Math.floor(h / 24); return `${d}d ago`;
    }

    // ===== Demo generator (optional) =====
    function startDemo(){
      const posters = [
        'https://images.unsplash.com/photo-1529101091764-c3526daf38fe?q=80&w=640&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1553531384-397c80973a05?q=80&w=640&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1511765224389-37f0e77cf0eb?q=80&w=640&auto=format&fit=crop'
      ];
      const names = ['Kim', 'Lee', 'Park', 'Choi', 'Han', 'Yun'];
      const depts = ['2D', '3D', 'UX/UI', 'Game'];
      const zones = ['A','B','C'];
      const emojis = ['✨','😍','👏','🔥','🧠','👍'];
      setInterval(() => {
        const z = zones[Math.floor(Math.random()*zones.length)];
        const item = normalizeItem({
          id: crypto.randomUUID(),
          zone: z,
          type: Math.random() < .15 ? 'emoji' : 'comment',
          text: Math.random() < .15 ? '' : ['멋져요!','대단합니다','색감 좋다','몰입감 최고','구성이 탄탄함'][Math.floor(Math.random()*5)],
          author: { name: names[Math.floor(Math.random()*names.length)], department: depts[Math.floor(Math.random()*depts.length)], studentId: '23' + Math.floor(Math.random()*900+100) },
          reactions: Math.random() < .7 ? [{ emoji: emojis[Math.floor(Math.random()*emojis.length)], count: Math.floor(Math.random()*8)+1 }] : [],
          likes: Math.random() < .5 ? Math.floor(Math.random()*40) : undefined,
          artwork: Math.random() < .55 ? { title: 'Poster', poster: posters[Math.floor(Math.random()*posters.length)] } : null,
          time: Date.now()
        });
        const zone = mapIncomingToZone(item);
        upsertMessage(store, zone, item); renderColumn(zone, store[zone]);
        if (zone !== 'ALL') { upsertMessage(store, 'ALL', item); renderColumn('ALL', store.ALL); }
      }, 1100);
    }
  </script>
</body>
</html>
